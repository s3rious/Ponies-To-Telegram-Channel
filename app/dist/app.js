parcelRequire=function(e,r,n,t){var i="function"==typeof parcelRequire&&parcelRequire,o="function"==typeof require&&require;function u(n,t){if(!r[n]){if(!e[n]){var f="function"==typeof parcelRequire&&parcelRequire;if(!t&&f)return f(n,!0);if(i)return i(n,!0);if(o&&"string"==typeof n)return o(n);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[n][1][r]||r};var l=r[n]=new u.Module(n);e[n][0].call(l.exports,p,l,l.exports,this)}return r[n].exports;function p(e){return u(p.resolve(e))}}u.isParcelRequire=!0,u.Module=function(e){this.id=e,this.bundle=u,this.exports={}},u.modules=e,u.cache=r,u.parent=i,u.register=function(r,n){e[r]=[function(e,r){r.exports=n},{}]};for(var f=0;f<n.length;f++)u(n[f]);if(n.length){var c=u(n[n.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=c:"function"==typeof define&&define.amd?define(function(){return c}):t&&(this[t]=c)}return u}({"4itQ":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=process.env.GRABBING_CRON_INTERVAL,N=process.env.GRABBING_PAGES?parseInt(process.env.GRABBING_PAGES,10):null,A=process.env.GRABBING_URLS,E=process.env.POSTING_CRON_INTERVAL,G=process.env.TELEGRAM_BOT_TOKEN,_=process.env.TELEGRAM_CHANNEL_NAME,O=process.env.MONGO_DATABASE,R=process.env.MONGO_USER,s=process.env.MONGO_PASSWORD;function r(e){return Object.keys(e).forEach(N=>{if(!e[N])throw new Error(`process.env.${N} variable is empty`)})}r({GRABBING_CRON_INTERVAL:e,GRABBING_PAGES:N,GRABBING_URLS:A,POSTING_CRON_INTERVAL:E,TELEGRAM_BOT_TOKEN:G,TELEGRAM_CHANNEL_NAME:_,MONGO_DATABASE:O,MONGO_USER:R,MONGO_PASSWORD:s});const S={UNPUBLISHED:"unpublished",PROCESSING:"processing",POSTED:"posted",ERROR:"error"};exports.default={GRABBING_CRON_INTERVAL:e,GRABBING_PAGES:N,GRABBING_URLS:A,POSTING_CRON_INTERVAL:E,TELEGRAM_BOT_TOKEN:G,TELEGRAM_CHANNEL_NAME:_,MONGO_DATABASE:O,MONGO_USER:R,MONGO_PASSWORD:s,STATUSES:S},module.exports=exports.default;
},{}],"fygA":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.logger=void 0;var e=require("intel"),l=o(e);function o(e){return e&&e.__esModule?e:{default:e}}l.default.config({formatters:{simple:{format:"[%(date)s] %(levelname)s: %(message)s",colorize:!1}},handlers:{console:{class:l.default.handlers.Console,formatter:"simple",level:l.default.VERBOSE},file:{class:l.default.handlers.File,level:l.default.VERBOSE,file:"./logs/verbose.log",formatter:"simple"}},loggers:{logger:{handlers:["console","file"],level:l.default.VERBOSE,handleExceptions:!0,exitOnError:!1,propagate:!1}}});const r=exports.logger=l.default.getLogger("logger");
},{}],"EJpi":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("mongoose"),t=r(e),o=require("./config.js");function r(e){return e&&e.__esModule?e:{default:e}}const s=process.env.MONGO_PORT_27017_TCP_ADDR||"localhost",n=process.env.MONGO_PORT_27017_TCP_PORT||27017;t.default.Promise=Promise,t.default.connect(`mongodb://${s}:${n}/${o.MONGO_DATABASE}`,{user:o.MONGO_USER,pass:o.MONGO_PASSWORD});const i=new e.Schema({id:{type:Number,index:!0},src:String,original_source:String,format:String,mime_type:String,status:{type:String,index:!0}},{timestamps:!0}),u=t.default.model("Image",i);exports.default={mongoose:t.default,Image:u},module.exports=exports.default;
},{"./config.js":"4itQ"}],"ogyi":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.grabImages=void 0;var e=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e};let r=(()=>{var e=b(function*(){try{y.logger.info("... getting last episode...");const e=yield(0,c.default)({url:"http://mlp-episodes.tk/",json:!1}),r=d.default.load(e)(".mlpepisode_new").data(),n={s:r.episodeSeason,e:r.episodeNumber};return y.logger.info("... last episode is:",n),n}catch(e){const r={s:0,e:0};return y.logger.info("... something went wrong, let’s consider last episode is:",r),y.logger.error(e),r}});return function(){return e.apply(this,arguments)}})(),n=(()=>{var e=b(function*(e,r){const n=/spoiler:s(\d{2})e(\d{2})/;return e.filter(function(e){let t=!0;const o=e.tags;if(n.test(o)){const i=o.match(n,"$1,$2"),u={s:parseInt(i[1],10),e:parseInt(i[2],10)};(t=Number(`${r.s}${r.e}`)>Number(`${u.s}${u.e}`))||y.logger.info(`... image ${e.id} filtered due to spoiler alert for s${u.s}e${u.e}...`)}return t})});return function(r,n){return e.apply(this,arguments)}})(),t=(()=>{var e=b(function*(e,r,t){const o=j(e.search);y.logger.info(`... dupes for page ${r} cleared...`);const i=yield n(o,t);return y.logger.info(`... spoilers for page ${r} cleared...`),i.map(function(e){return{id:parseInt(e.id,10),src:I(e.representations.large),original_source:e.source_url?e.source_url:`https://derpibooru.org/${e.id}`,format:e.original_format,mime_type:e.mime_type,status:$.STATUSES.UNPUBLISHED}})});return function(r,n,t){return e.apply(this,arguments)}})(),o=(()=>{var e=b(function*(e,r,n){y.logger.info(`... grabbing page ${r}...`);try{const o=yield(0,c.default)({url:_(e,r),json:!0});return y.logger.info(`... got response for page ${r}...`),yield t(o,r,n)}catch(e){return y.logger.info(`... something went wrong ${r} didn't grabbed...`),y.logger.error(e),[]}});return function(r,n,t){return e.apply(this,arguments)}})(),i=(()=>{var e=b(function*(e,r,n){let t=[];return yield r.reduce(function(r,i){return r.then(b(function*(){const r=yield o(e,i,n);t=[...t,...r]}))},new Promise(function(e){return e()})),t});return function(r,n,t){return e.apply(this,arguments)}})(),u=(()=>{var e=b(function*(e,r,n){y.logger.info(`... grabbing ${r} pages from ${e}...`);const t=(0,m.range)(1,r+1,1),o=yield i(e,t,n),u=(0,m.flattenDeep)(o);return y.logger.info(`... ${r} pages from ${e} grabbed, we’ve got ${u.length} images...`),u});return function(r,n,t){return e.apply(this,arguments)}})(),s=(()=>{var e=b(function*(e,r,n){let t=[];return yield e.reduce(function(e,o){return e.then(b(function*(){const e=yield u(o,r,n);t=[...t,...e]}))},new Promise(function(e){return e()})),t});return function(r,n,t){return e.apply(this,arguments)}})(),a=(()=>{var r=b(function*(r){let n=null;y.logger.info(`... saving ${r.id} to mongo...`);let t=yield h.Image.findOne({id:r.id});return t?y.logger.info(`... image ${r.id} is already exist in mongo database...`):(n=(t=new h.Image(e({},r))).save(),y.logger.info(`... image ${r.id} saved to mongo...`)),n});return function(e){return r.apply(this,arguments)}})(),l=(()=>{var e=b(function*(e){return y.logger.info(`... saving ${e.length} images to mongo...`),(yield Promise.all(e.map(function(e){return a(e)}))).map(function(e){return Number(Boolean(e))}).reduce(function(e=0,r){return e+r})});return function(r){return e.apply(this,arguments)}})(),g=exports.grabImages=(()=>{var e=b(function*(e){y.logger.info("New grabbing job started...");const n=yield r(),t=w(),o=yield s(t,e,n),i=yield l(o);y.logger.info(`... ${i} new images stored!`)});return function(r){return e.apply(this,arguments)}})();var f=require("request-promise"),c=v(f),p=require("cheerio"),d=v(p),m=require("lodash"),y=require("./logger"),h=require("./mongo.js"),$=require("./config.js");function v(e){return e&&e.__esModule?e:{default:e}}function b(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,n){return function t(o,i){try{var u=r[o](i),s=u.value}catch(e){return void n(e)}if(!u.done)return Promise.resolve(s).then(function(e){t("next",e)},function(e){t("throw",e)});e(s)}("next")})}}function w(){return $.GRABBING_URLS.split(",")}function _(e,r){return`${e}&page=${r}`}function I(e){return/^http/.test(e)?e:`https:${e}`}function j(e){return e.filter(e=>{const r=e.duplicate_reports.length>0;return r&&y.logger.info(`... image ${e.id} filtered due to duplicate report...`),!r})}
},{"./logger":"fygA","./mongo.js":"EJpi","./config.js":"4itQ"}],"OAQW":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.postImages=void 0;var e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};let t=(()=>{var e=h(function*(e,t,n=m){let r=e;try{f.logger.info(`... setting processing status for image ${r.id}...`),r.status=t,yield r.save(),f.logger.info("... status changed...")}catch(e){r=null,f.logger.info(`... something went wrong, ${r.id} status isn't changed, trying to revert it...`),f.logger.error(e),r.status=n,yield r.save()}return r});return function(t,n){return e.apply(this,arguments)}})(),n=(()=>{var e=h(function*(e){let n=null;try{f.logger.info(`... downloading image ${e.id}...`),n=yield new Promise(function(t,r){var o;y.get(e.src,(o=h(function*(o,i,g){if(o||200!==i.statusCode)throw r(o),new Error(o);n=`./.tmp/${e.id}.${e.format}`,yield(0,l.writeFile)(n,new Buffer(g)),f.logger.info(`... image ${e.id} downloaded...`),t(n)}),function(e,t,n){return o.apply(this,arguments)}))})}catch(n){f.logger.info(`... something went wrong, ${e.id} isn't downloaded...`),t(e,_),f.logger.error(n)}return n});return function(t){return e.apply(this,arguments)}})(),r=(()=>{var n=h(function*(n,r){const o="gif"===n.format,i=o?"sendDocument":"sendPhoto",g=o?"document":"photo";let l=null,s={chat_id:`@${d.TELEGRAM_CHANNEL_NAME}`,[g]:r};o||(s=e({},s,{caption:n.original_source}));try{f.logger.info(`... posting ${n.id} ${g} to a @${d.TELEGRAM_CHANNEL_NAME} channel...`);const e=yield v[i](s);if(o){const{message_id:t}=e;yield v.sendMessage({chat_id:`@${d.TELEGRAM_CHANNEL_NAME}`,text:n.original_source,reply_to_message_id:t,disable_web_page_preview:"true"})}f.logger.info(`... ${n.id} posted into a @${d.TELEGRAM_CHANNEL_NAME}...`),l=n}catch(e){f.logger.info(`... something went wrong, ${n.id} isn't posted...`),t(n,_),f.logger.error(e)}return l});return function(e,t){return n.apply(this,arguments)}})(),o=(()=>{var e=h(function*(e){let t=null;try{f.logger.info(`... deleting temporary file at ${e}...`),t=yield(0,l.unlink)(e),f.logger.info(`... ${e} deleted...`)}catch(t){f.logger.info(`... something went wrong, ${e} isn't deleted...`),f.logger.error(t)}return t});return function(t){return e.apply(this,arguments)}})(),i=(()=>{var e=h(function*(e){f.logger.info(`... posting image ${e.id}...`);const i=yield t(e,w),g=yield n(i),l=yield r(i,g),s=yield t(l,E);return f.logger.info(`... ${e.id} posted...`),yield o(g),s});return function(t){return e.apply(this,arguments)}})(),g=exports.postImages=(()=>{var e=h(function*(){f.logger.info("New posting job started...");const e=yield c.Image.find({status:m}).sort({id:-1});f.logger.info(`... we've got ${e.length} unposted images...`);let t=Math.ceil(e.length/10);t=t<5&&t>0?t=5:t;const n=(0,s.take)(e,t);n.length>0?(f.logger.info(`... posting ${n.length} right now...`),yield $(n)):f.logger.info("... nothing to post..."),f.logger.info(`${n.length} images posted!`)});return function(){return e.apply(this,arguments)}})();var l=require("fs-promise"),s=require("lodash"),u=require("telegram-bot-api"),a=p(u),d=require("./config.js"),c=require("./mongo.js"),f=require("./logger");function p(e){return e&&e.__esModule?e:{default:e}}function h(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function r(o,i){try{var g=t[o](i),l=g.value}catch(e){return void n(e)}if(!g.done)return Promise.resolve(l).then(function(e){r("next",e)},function(e){r("throw",e)});e(l)}("next")})}}const y=require("request").defaults({encoding:null}),{UNPUBLISHED:m,PROCESSING:w,POSTED:E,ERROR:_}=d.STATUSES,v=new a.default({token:d.TELEGRAM_BOT_TOKEN});function $(e){return e.reduce((e,t)=>e.then(()=>i(t)),new Promise(e=>e()))}
},{"./config.js":"4itQ","./mongo.js":"EJpi","./logger":"fygA"}],"5El7":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("cron"),r=require("./config.js"),o=require("./grabber.js"),n=require("./poster.js");const t=new e.CronJob({cronTime:r.GRABBING_CRON_INTERVAL,onTick:()=>(0,o.grabImages)(r.GRABBING_PAGES),start:!0,runOnInit:!0}),s=new e.CronJob({cronTime:r.POSTING_CRON_INTERVAL,onTick:()=>(0,n.postImages)(s),start:!0,runOnInit:!0});exports.default={grabbing:t,posting:s},module.exports=exports.default;
},{"./config.js":"4itQ","./grabber.js":"ogyi","./poster.js":"OAQW"}],"A2T1":[function(require,module,exports) {
require("babel-register"),require("./jobs.js");
},{"./jobs.js":"5El7"}]},{},["A2T1"], null)
//# sourceMappingURL=/app.map